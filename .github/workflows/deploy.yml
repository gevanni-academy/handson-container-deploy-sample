name: Build and Deploy to ECS

on:
  push:
    branches:
      - main  # mainブランチへのpushをトリガーに実行

permissions:
  id-token: write       # OIDCトークンを発行するために必要
  contents: read        # リポジトリ内容を取得するために必要

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: handson-go-sample
  ECS_CLUSTER: handson-cluster
  ECS_SERVICE: handson-service

jobs:
  # --------------------------
  # 1. Build & Push Job
  # --------------------------
  build:
    name: Build and Push Docker image
    runs-on: ubuntu-latest

    steps:
      # ソースコードをチェックアウト
      - name: Checkout source
        uses: actions/checkout@v4

      # AWS認証情報を設定 (OIDCを利用)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-deploy-role
          aws-region: ${{ env.AWS_REGION }}

      # ECRへログイン
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # イメージをビルド
      - name: Build Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker build -t $ECR_REPOSITORY:$IMAGE_TAG .

      # イメージにタグを付与
      - name: Tag Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker tag $ECR_REPOSITORY:$IMAGE_TAG ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:$IMAGE_TAG

      # イメージをECRにプッシュ
      - name: Push Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker push ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:$IMAGE_TAG
          echo "image=${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_ENV

      # デプロイジョブにイメージ情報を渡す
      - name: Export image URI
        id: export-image
        run: echo "image=${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:${{ github.sha }}" >> $GITHUB_OUTPUT
        shell: bash

    outputs:
      image: ${{ steps.export-image.outputs.image }}

  # --------------------------
  # 2. Deploy Job
  # --------------------------
  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    needs: build   # buildジョブが完了してから実行

    steps:
      # AWS認証情報を設定
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-deploy-role
          aws-region: ${{ env.AWS_REGION }}

      # 新しいイメージでECSを更新
      - name: Deploy to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ecs-taskdef.json
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
